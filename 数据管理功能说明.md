# Smart Dog Scratch 数据管理功能说明

## 概述

本系统专注于工作区数据和自定义积木块的管理，提供了完整的本地存储和文件操作功能。数据管理设计遵循简化原则，只关注核心数据实体，确保用户体验的流畅性和数据的安全性。

## 核心数据实体

### 1. 工作区数据 (Workspace Data)

工作区数据包含用户当前编辑的Blockly工作区状态：

```typescript
interface WorkspaceState {
  xml: string;                  // Blockly XML格式的工作区状态
  blocks: any[];               // 所有积木块信息（序列化）
  variables: string[];         // 定义的变量
  functions: any[];            // 自定义函数
}
```

**功能特性：**
- 实时保存工作区状态到本地存储
- 支持Blockly XML格式的导入导出
- 自动跟踪积木块变化
- 变量和函数的状态管理

### 2. 自定义积木块 (Custom Blocks)

自定义积木块允许用户创建和重用特定的功能模块：

```typescript
interface CustomBlockDefinition {
  id: string;                    // 积木块唯一标识
  name: string;                  // 积木块显示名称
  category: string;              // 所属分类
  color: string;                 // 颜色（十六进制）
  inputs: Array<{                // 输入参数
    type: string;               // 参数类型
    name: string;               // 参数名称
    value?: any;               // 默认值
    options?: any[];           // 下拉选项
  }>;
  code: string;                  // 生成的代码模板
}
```

**功能特性：**
- 自定义积木块的创建、编辑、删除
- 自动同步到Blockly工具箱
- 代码模板支持变量替换
- 分类和颜色管理

## 数据结构

### WorkspaceData 接口

```typescript
interface WorkspaceData {
  workspace: WorkspaceState;   // 工作区状态
  customBlocks: CustomBlockDefinition[]; // 自定义积木块
}
```

这个简化结构只包含两个核心组件，确保数据的清晰性和可维护性。

## 数据持久化策略

### 本地存储层级

1. **内存 (Memory)** - 当前编辑状态
2. **自动保存 (Auto-save)** - localStorage，防崩溃恢复
3. **项目文件 (Project)** - JSON文件，完整保存

### 自动保存机制

```typescript
// 自动保存策略
const autoSaveStrategy = {
  onChange: true,     // 内容变化时保存（防抖1秒）
  maxVersions: 10     // 保留10个历史版本
};
```

**实现细节：**
- 工作区变化时触发自动保存
- 使用防抖技术避免频繁保存
- 保存到浏览器的localStorage
- 支持从崩溃中恢复数据

## 文件操作功能

### 基础文件操作

1. **新建工作区** - 创建空白工作区
2. **保存到本地存储** - 保存当前工作区状态
3. **导出为文件** - 导出为JSON格式文件
4. **从文件导入** - 从JSON文件恢复工作区

### 导入/导出格式

#### JSON格式 (.smartdog)
完整的工作区数据，包含：
- 工作区XML
- 积木块信息
- 变量定义
- 自定义积木块

#### Blockly XML格式 (.xml)
仅包含工作区布局，用于与其他Blockly项目兼容。

## 数据验证和迁移

### 数据验证
- 格式验证：确保JSON结构正确
- 完整性检查：验证必要字段是否存在
- 版本兼容：检查文件版本是否支持

### 数据迁移
支持未来版本升级时的数据迁移，确保向后兼容性。

## 用户体验功能

### 文件管理界面
- **文件菜单**：标准文件操作入口
- **拖放支持**：拖拽文件到页面打开
- **操作反馈**：保存成功/失败提示

### 工作区统计
实时显示工作区状态：
- 积木块数量
- 变量数量
- 自定义积木块数量
- 函数数量

### 状态指示器
- 当前工作区状态显示
- 自动保存状态指示
- 数据变化提示

## 数据安全考虑

### 本地数据安全
- **数据备份**：定期自动备份
- **恢复功能**：从备份恢复数据
- **清理工具**：清理过期或损坏数据

### 文件安全
- **文件验证**：打开前验证文件完整性
- **大小限制**：防止超大文件导致崩溃
- **格式检查**：确保是合法的文件格式

## 技术实现要点

### 数据服务架构
```typescript
class DataService {
  // 单例模式
  static getInstance(): DataService;
  
  // 工作区操作
  initializeWorkspace(): WorkspaceData;
  updateWorkspaceState(xml, blocks, variables, functions): void;
  
  // 自定义积木块操作
  updateCustomBlocks(blocks): void;
  addCustomBlock(block): void;
  removeCustomBlock(id): void;
  
  // 存储操作
  saveToLocalStorage(): void;
  loadFromLocalStorage(): WorkspaceData | null;
  clearLocalStorage(): void;
  
  // 文件操作
  exportToFile(filename): void;
  importFromFile(file): Promise<WorkspaceData>;
}
```

### 事件驱动架构
- **workspaceChanged**：工作区变化事件
- **customBlocksChanged**：自定义积木块变化事件
- **codeGenerated**：代码生成事件

## 与现有系统的集成

### 与ScratchEditor集成
- 自动监听工作区变化
- 实时更新数据服务
- 支持保存/加载功能

### 与CustomBlockManager集成
- 自定义积木块状态同步
- 工具箱动态更新
- 代码生成器注册

## 使用示例

### 基本使用流程

1. **启动应用**
   - 自动从localStorage加载上次的工作区
   - 如果无保存数据，创建新的工作区

2. **编辑工作区**
   - 拖拽积木块进行编程
   - 数据自动保存到localStorage

3. **管理自定义积木块**
   - 通过"管理自定义积木块"按钮打开管理器
   - 创建、编辑、删除自定义积木块

4. **文件操作**
   - 使用"文件"菜单进行导入导出
   - 支持JSON和XML格式

5. **数据备份**
   - 定期使用"导出为文件"功能备份数据
   - 可随时从文件恢复

### 代码示例

```javascript
// 初始化数据服务
import { dataService } from './services/dataService';

// 获取当前数据
const currentData = dataService.getCurrentData();

// 更新工作区状态
dataService.updateWorkspaceState(xml, blocks, variables, functions);

// 添加自定义积木块
dataService.addCustomBlock({
  id: 'custom_001',
  name: '旋转舞蹈 {times} 次',
  category: '舞蹈动作',
  color: '#FF9800',
  inputs: [{ type: 'field_number', name: 'times', value: 3 }],
  code: 'for(let i=0; i<{times}; i++) { dog.turn(90); dog.wait(0.5); }'
});

// 导出数据到文件
dataService.exportToFile('my_project.smartdog');
```

## 故障排除

### 常见问题

1. **数据丢失**
   - 检查浏览器localStorage是否被清除
   - 使用"从文件导入"恢复备份

2. **导入失败**
   - 确保文件格式正确
   - 检查文件版本兼容性

3. **性能问题**
   - 减少工作区中积木块数量
   - 定期清理不再使用的自定义积木块

### 调试建议

1. 打开浏览器开发者工具
2. 查看Console中的日志信息
3. 检查Application > LocalStorage中的数据
4. 使用Network面板监控文件操作

## 未来扩展

### 计划功能
1. **云同步** - 跨设备数据同步
2. **版本控制** - 工作区历史版本管理
3. **项目模板** - 预定义的项目模板
4. **协作功能** - 多人实时协作编辑

### 技术改进
1. **增量保存** - 只保存变化部分
2. **数据压缩** - 减少存储空间占用
3. **离线优先** - 更好的离线体验
4. **PWA支持** - 渐进式Web应用

---

## 总结

本数据管理系统为Smart Dog Scratch提供了稳定、可靠的数据管理基础，专注于工作区数据和自定义积木块的核心需求。通过简化设计、自动保存和完整的文件操作支持，确保了用户数据的完整性和可访问性，同时为未来的功能扩展奠定了坚实基础。

**核心优势：**
- ✅ 专注于工作区数据和自定义积木块
- ✅ 自动保存，防数据丢失
- ✅ 完整的导入导出功能
- ✅ 简洁清晰的数据结构
- ✅ 良好的用户体验
- ✅ 可扩展的架构设计